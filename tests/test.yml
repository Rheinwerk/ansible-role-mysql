---
- hosts: localhost
  connection: local
  become: yes
  vars:
    RW_APT_CACHE_UPDATE: yes
    MYSQL:
      default_config: no
      listen:
        ip: 127.0.0.1
        port: 3306
      root:
        password: "root"
      users:
        wordpress:
          state: present
          name: wordpress
          password: "wordpress"
          privileges: "wordpress.*:ALL,GRANT"
          hosts:
            - localhost
        backup:
          state: present
          name: backup
          password: "backup"
          privileges: '*.*:SELECT,LOCK TABLES,RELOAD,REPLICATION CLIENT'
          hosts:
            - localhost
      databases:
        wordpress:
          state: present
  pre_tasks:
    # This is necessary because Travis already installed mysql
    - name: Remove already Installed MySQL Packages
      shell: apt-get purge mysql-client-5.7 mysql-client-core-5.7 mysql-server-5.7 mysql-server-core-5.7 mysql-common-5.7 mysql-common && apt-get autoremove && apt-get autoclean
    - name: Remove garbage
      shell: rm /var/lib/mysql/debian-*.flag
    - name: Remove default dirs created by package
      file: name="{{ item }}" state=absent
      with_items:
        - /var/lib/mysql
        - /var/log/mysql
        - /var/log/mysqld.log
    - name: Debugging
      shell: "dpkg -l | grep mysql"
  roles:
    - { role: ansible-role-mysql, tags: ['mysql'], _mysql: "{{ MYSQL }}" }

